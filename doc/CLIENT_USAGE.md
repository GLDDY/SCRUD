# 视频监控客户端使用说明

## 概述

`video_client.c` 是智能家庭视频监控系统的客户端程序，用于接收服务器端发送的截屏图像。

## 主要特性

### 1. 连接机制
- TCP 连接到服务器（默认端口 8888）
- 保持长连接，等待接收截屏数据
- 自动重连机制（未来可扩展）

### 2. 数据接收
- 接收服务器发送的截屏图像
- 不是连续视频流，而是按需截屏
- 只有在服务器端点击【截屏】按钮时才会接收图像

### 3. 图像格式
- 支持 YUYV 格式（与摄像头原始格式一致）
- 分辨率：640x480
- 自动转换为 PPM 格式保存

### 4. 数据包结构
客户端与服务器使用统一的数据包格式：

```c
typedef struct
{
  unsigned int magic;      // 魔数 0x12345678 (用于验证)
  unsigned int frame_size; // 帧数据大小
  unsigned int width;      // 图像宽度 (640)
  unsigned int height;     // 图像高度 (480)
  unsigned int format;     // 图像格式 (0=YUYV)
  unsigned int timestamp;  // 时间戳
} frame_header_t;
```

## 编译方法

### 在 PC 上编译（推荐）

```bash
make client
```

这会使用本地 gcc 编译器生成 x86 可执行文件。

### 手动编译

```bash
gcc -Wall -O2 -o video_client video_client.c -lpthread
```

## 使用方法

### 1. 基本用法

```bash
./video_client <服务器IP> <端口>
```

### 2. 示例

连接到开发板（假设开发板 IP 为 192.168.1.100）：

```bash
./video_client 192.168.1.100 8888
```

连接到本地测试服务器：

```bash
./video_client 127.0.0.1 8888
```

### 3. 参数说明

- `<服务器IP>`: 运行 video_server 的设备 IP 地址
- `<端口>`: 服务器监听端口（默认 8888）

## 运行流程

### 1. 启动阶段

```
========================================
   智能家庭视频监控系统 - 客户端
========================================

正在连接服务器 192.168.1.100:8888...
成功连接到服务器!

========================================
正在等待接收截屏图像...
按 Ctrl+C 退出
提示: 在服务器端点击【截屏】按钮发送图片
========================================
```

### 2. 接收截屏

当服务器端点击【截屏】按钮后：

```
等待接收截屏...
接收图像数据中... (大小: 614400 bytes)

========================================
接收到截屏 #1
  时间: 2025-10-19 14:30:25
  分辨率: 640x480
  格式: YUYV
  大小: 614400 bytes
========================================
保存帧 1 到 frame_0001.ppm
```

### 3. 退出

按 `Ctrl+C` 退出：

```
^C
接收到信号 2, 正在关闭客户端...

========================================
客户端统计信息:
  接收截屏数: 5
  运行时间: 120 秒
========================================
客户端已关闭
```

## 输出文件

### PPM 图像文件

客户端会将接收到的每一帧保存为 PPM 格式：

- 文件名：`frame_0001.ppm`, `frame_0002.ppm`, ...
- 格式：PPM P6 (RGB 24位)
- 分辨率：640x480

### 查看 PPM 文件

**Linux:**
```bash
# 使用 ImageMagick
display frame_0001.ppm

# 使用 GIMP
gimp frame_0001.ppm

# 转换为 JPEG
convert frame_0001.ppm frame_0001.jpg
```

**Windows:**
```powershell
# 使用 IrfanView、XnView 等支持 PPM 的查看器
# 或者使用 ImageMagick (Windows 版本)
magick frame_0001.ppm frame_0001.jpg
```

## 工作原理

### 1. 数据接收流程

```
客户端                          服务器
  |                               |
  |-------- TCP 连接 ------------>|
  |                               |
  |<------ 连接成功 --------------|
  |                               |
  |     等待截屏指令...           |
  |                               |
  |                        [用户点击截屏按钮]
  |                               |
  |<------ frame_header_t --------|
  |<------ YUYV 数据 -------------|
  |                               |
  | 验证魔数                      |
  | 接收图像数据                  |
  | 转换并保存为 PPM              |
  |                               |
  |     继续等待...              |
```

### 2. 关键函数

#### `recv_full()`
```c
int recv_full(int sock, void *buffer, size_t size)
```
- 确保接收完整的数据（处理部分接收）
- 返回 0 表示成功，-1 表示失败

#### `save_frame_as_ppm()`
```c
void save_frame_as_ppm(const unsigned char *yuyv, int width, int height, int frame_num)
```
- 将 YUYV 格式转换为 RGB24
- 保存为 PPM 格式文件

## 常见问题

### 1. 连接失败

**问题：** `connect: Connection refused`

**解决方法：**
- 检查服务器是否已启动
- 确认服务器 IP 地址正确
- 检查防火墙设置
- 确认端口号正确（默认 8888）

### 2. 无效的数据包魔数

**问题：** `错误: 无效的数据包魔数 0xXXXXXXXX (期望 0x12345678)`

**解决方法：**
- 确保客户端和服务器版本匹配
- 检查网络连接质量
- 可能存在数据损坏，尝试重新连接

### 3. 接收超时

**问题：** 长时间显示 `等待接收截屏...`

**正常情况：**
- 这是预期行为
- 服务器只在用户点击【截屏】按钮时才发送数据
- 客户端会一直等待，直到接收到数据或连接断开

### 4. 无法保存文件

**问题：** `打开文件失败: Permission denied`

**解决方法：**
- 检查当前目录的写权限
- 确保磁盘空间充足
- 在有写权限的目录运行客户端

## 与服务器端配合使用

### 完整测试流程

1. **在开发板上启动服务器：**
   ```bash
   ./video_server
   # 选择 [3] 视频监控功能
   ```

2. **在 PC 上启动客户端：**
   ```bash
   ./video_client 192.168.1.100 8888
   ```

3. **触发截屏：**
   - 在开发板触摸屏上点击【截屏】按钮（屏幕右下角）
   - 或者使用其他触发方式（如果实现了）

4. **查看结果：**
   - 客户端显示接收信息
   - 当前目录生成 PPM 文件
   - 使用图像查看器打开

### 多客户端支持

服务器支持最多 10 个客户端同时连接：

```bash
# 终端 1
./video_client 192.168.1.100 8888

# 终端 2
./video_client 192.168.1.100 8888

# 终端 3
./video_client 192.168.1.100 8888
```

当服务器发送截屏时，所有连接的客户端都会同时接收。

## 代码修改记录

### 主要改动

1. **移除不必要的头文件**
   - 删除 `camera.h`, `lcd.h`, `bmp.h`, `ts.h`
   - 这些是服务器端专用的硬件接口

2. **添加数据包结构定义**
   - 与服务器保持一致的 `frame_header_t`
   - 包含魔数验证机制

3. **修改接收逻辑**
   - 改为等待模式（不是连续流）
   - 每次接收显示详细信息
   - 添加时间戳显示

4. **优化用户提示**
   - 清晰说明这是截屏接收而非视频流
   - 提示用户在服务器端操作

## 性能特点

- **网络带宽：** 每张图片约 614KB（640x480 YUYV）
- **传输时间：** 在局域网内通常 < 100ms
- **存储空间：** PPM 格式较大，每张约 900KB
- **内存占用：** 约 1.2MB（包括接收缓冲区）

## 未来扩展

### 可能的改进方向

1. **图像压缩**
   - 支持 JPEG 格式保存
   - 减少存储空间

2. **实时显示**
   - 集成图像显示窗口
   - 使用 SDL、GTK 等 GUI 库

3. **自动重连**
   - 连接断开后自动重连
   - 增强稳定性

4. **多种保存格式**
   - BMP
   - PNG
   - JPEG

5. **图像处理**
   - 亮度/对比度调整
   - 滤镜效果
   - 缩放功能

## 技术参考

### YUYV 格式

YUYV 是一种 YUV 4:2:2 格式：
- Y0 U0 Y1 V0 (4 字节表示 2 个像素)
- Y 表示亮度，U/V 表示色度
- 每个像素平均 2 字节

### PPM 格式

PPM (Portable Pixmap) 是一种简单的图像格式：
- P6 表示二进制 RGB 格式
- 文件头包含宽度和高度
- 每个像素 3 字节（RGB）

## 相关文档

- `VIDEO_MONITOR_README.md` - 服务器端功能说明
- `REFACTORING_GUIDE.md` - 代码重构说明
- `DEPLOYMENT_GUIDE.md` - 部署指南
- `server_module.h` - 服务器模块接口

## 总结

`video_client.c` 提供了一个简洁、可靠的客户端实现，能够正确接收服务器发送的截屏图像。通过使用统一的数据包格式和魔数验证，确保了数据传输的完整性和正确性。
