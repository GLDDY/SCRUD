# 客户端-服务器测试指南

## 快速测试步骤

### 1. 编译程序

#### 编译服务器端（ARM）
```bash
make clean
make server
```

#### 编译客户端（PC）
```bash
make client
```

### 2. 部署服务器到开发板

```bash
# 方法 1: 使用 Makefile
make deploy BOARD_IP=192.168.1.100

# 方法 2: 手动 SCP
scp video_server root@192.168.1.100:/root/
```

### 3. 启动服务器

在开发板上：
```bash
cd /root
./video_server
# 选择 [3] 视频监控功能
```

### 4. 启动客户端

在 PC 上（与开发板在同一局域网）：
```bash
./video_client 192.168.1.100 8888
```

### 5. 触发截屏

在开发板触摸屏上：
- 点击屏幕右下角的【截屏】按钮（坐标范围：x:640-800, y:240-480）

### 6. 查看结果

客户端会显示：
```
等待接收截屏...
接收图像数据中... (大小: 614400 bytes)

========================================
接收到截屏 #1
  时间: 2025-10-19 14:30:25
  分辨率: 640x480
  格式: YUYV
  大小: 614400 bytes
========================================
保存帧 1 到 frame_0001.ppm
```

### 7. 查看保存的图片

**Linux:**
```bash
# 使用 ImageMagick 显示
display frame_0001.ppm

# 或转换为 JPEG
convert frame_0001.ppm screenshot.jpg
```

**Windows:**
```powershell
# 使用 ImageMagick (Windows 版)
magick frame_0001.ppm screenshot.jpg

# 然后用系统默认查看器打开
start screenshot.jpg
```

## 测试场景

### 测试 1: 单客户端基本功能
1. 启动服务器
2. 启动一个客户端
3. 点击截屏 5 次
4. 验证客户端接收到 5 张图片

**预期结果：**
- 生成 `frame_0001.ppm` 到 `frame_0005.ppm`
- 每次截屏客户端都显示接收信息
- 图片内容为当前摄像头画面

### 测试 2: 多客户端同时接收
1. 启动服务器
2. 启动客户端 A（终端 1）
3. 启动客户端 B（终端 2）
4. 启动客户端 C（终端 3）
5. 在服务器端点击截屏

**预期结果：**
- 服务器显示：`当前客户端数: 3`
- 所有 3 个客户端同时接收到图片
- 每个客户端都保存了相同的图片

### 测试 3: 客户端断线重连
1. 启动服务器
2. 启动客户端 A
3. 服务器显示：`当前客户端数: 1`
4. 客户端 A 按 Ctrl+C 退出
5. 服务器显示：`当前客户端数: 0`
6. 重新启动客户端 A
7. 服务器显示：`当前客户端数: 1`

**预期结果：**
- 客户端可以正常退出
- 服务器正确检测到断开
- 客户端可以重新连接

### 测试 4: 服务器重启
1. 启动服务器和客户端
2. 在服务器端点击退出按钮
3. 客户端应该检测到连接断开
4. 重新启动服务器
5. 重新启动客户端

**预期结果：**
- 客户端检测到连接断开并退出
- 服务器可以正常重启
- 重启后系统恢复正常工作

### 测试 5: 长时间运行稳定性
1. 启动服务器和客户端
2. 每隔 30 秒点击一次截屏
3. 持续运行 30 分钟
4. 观察内存和 CPU 使用情况

**预期结果：**
- 无内存泄漏
- CPU 使用率稳定
- 所有截屏都能正确接收
- 无崩溃或错误

## 调试技巧

### 1. 查看服务器日志

服务器会输出详细日志：
```
添加客户端socket: 5, 当前客户端数: 1
发送截屏帧给所有客户端，大小: 614400 bytes
成功发送截屏到客户端: 5
截屏发送完成
```

### 2. 查看客户端日志

客户端也有详细输出：
```
正在连接服务器 192.168.1.100:8888...
成功连接到服务器!
等待接收截屏...
接收图像数据中... (大小: 614400 bytes)
```

### 3. 网络问题排查

#### 检查网络连接
```bash
# 在 PC 上 ping 开发板
ping 192.168.1.100

# 检查端口是否开放
telnet 192.168.1.100 8888
# 或使用 nc
nc -zv 192.168.1.100 8888
```

#### 检查防火墙
```bash
# 在开发板上临时关闭防火墙（如果有）
iptables -F
```

### 4. 使用 Wireshark 抓包

在 PC 上启动 Wireshark：
1. 选择网络接口
2. 过滤条件：`tcp.port == 8888`
3. 观察数据包传输

**正常流程应该看到：**
- TCP 三次握手（SYN, SYN-ACK, ACK）
- 数据传输（包含 frame_header_t 和图像数据）
- TCP 四次挥手（关闭连接时）

## 常见问题排查

### 问题 1: 客户端无法连接

**症状：**
```
正在连接服务器 192.168.1.100:8888...
connect: Connection refused
```

**排查步骤：**
1. 确认服务器已启动：`ps aux | grep video_server`
2. 确认服务器在监听：`netstat -an | grep 8888`
3. 检查 IP 地址是否正确
4. 检查防火墙设置

### 问题 2: 接收到的图片损坏

**症状：**
- PPM 文件无法打开
- 图片显示异常

**排查步骤：**
1. 检查文件大小是否正确（应该约 900KB）
2. 验证魔数是否正确
3. 检查网络质量（ping 延迟、丢包率）
4. 查看客户端是否报错

### 问题 3: 服务器没有响应

**症状：**
- 客户端显示 `等待接收截屏...` 但一直无数据

**这是正常的！**
- 服务器只在用户点击【截屏】按钮时才发送
- 不是自动发送或定时发送
- 需要手动触发

**验证方法：**
- 在开发板上观察触摸屏
- 确认【截屏】按钮位置（屏幕右下角）
- 点击后服务器应该输出 `发送截屏帧给所有客户端`

### 问题 4: 多客户端只有一个接收到

**症状：**
- 启动了 3 个客户端
- 只有第一个收到数据

**可能原因：**
- 客户端列表未正确维护
- Socket 被错误关闭

**排查：**
```bash
# 在服务器端查看输出
添加客户端socket: 5, 当前客户端数: 1
添加客户端socket: 6, 当前客户端数: 2
添加客户端socket: 7, 当前客户端数: 3

# 发送时应该看到
成功发送截屏到客户端: 5
成功发送截屏到客户端: 6
成功发送截屏到客户端: 7
```

## 性能测试

### 测试网络吞吐量

单次传输大小：614400 字节 (600KB)

**局域网测试（1000Mbps）：**
- 预期传输时间：< 10ms
- 实际测试：通常 5-15ms

**Wi-Fi 测试（54Mbps）：**
- 预期传输时间：< 100ms
- 实际测试：通常 50-150ms

### 测试多客户端负载

启动 10 个客户端（最大支持数）：
```bash
for i in {1..10}; do
  ./video_client 192.168.1.100 8888 &
done
```

观察：
- 服务器 CPU 使用率
- 内存占用
- 传输延迟

## 自动化测试脚本

### 测试脚本示例

```bash
#!/bin/bash
# test_client.sh - 自动化客户端测试

SERVER_IP="192.168.1.100"
PORT="8888"
TEST_DURATION=60  # 秒

echo "=========================================="
echo "客户端自动化测试"
echo "=========================================="
echo "服务器: $SERVER_IP:$PORT"
echo "测试时长: $TEST_DURATION 秒"
echo "=========================================="

# 清理旧文件
rm -f frame_*.ppm

# 启动客户端
./video_client $SERVER_IP $PORT &
CLIENT_PID=$!

echo "客户端已启动 (PID: $CLIENT_PID)"
echo "请在服务器端多次点击截屏按钮..."

# 等待测试完成
sleep $TEST_DURATION

# 停止客户端
kill -SIGINT $CLIENT_PID
wait $CLIENT_PID

# 统计结果
FRAME_COUNT=$(ls frame_*.ppm 2>/dev/null | wc -l)

echo "=========================================="
echo "测试完成"
echo "接收帧数: $FRAME_COUNT"
echo "平均速率: $(echo "scale=2; $FRAME_COUNT / $TEST_DURATION * 60" | bc) 帧/分钟"
echo "=========================================="
```

## 总结

通过以上测试流程，您可以：
1. ✅ 验证客户端能正确连接服务器
2. ✅ 确认截屏功能正常工作
3. ✅ 测试多客户端并发场景
4. ✅ 检查系统稳定性和可靠性
5. ✅ 排查和解决常见问题

如有问题，请参考：
- `CLIENT_USAGE.md` - 客户端详细使用说明
- `VIDEO_MONITOR_README.md` - 服务器端功能说明
- `DEPLOYMENT_GUIDE.md` - 完整部署指南
